<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Journal</title>
    <link rel="manifest" href="manifest.json">
    <script>
       if ('serviceWorker' in navigator) {
           window.addEventListener('load', () => {
               navigator.serviceWorker.register('service-worker.js')
               .then((registration) => {
                   console.log('Service Worker registered with scope:', registration.scope);
               })
               .catch((error) => {
                   console.log('Service Worker registration failed:', error);
               });
           });
       }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Mono', monospace; }
        table { border-collapse: collapse; margin: 20px auto; }
        table, td { border: 1px solid black; }
        td { width: 40px; height: 40px; text-align: center; font-size: 26px; }
        input { width: 100%; height: 100%; text-align: center; font-size: 26px; }
        #log { width: 90%; margin: 20px auto; text-align: center; }
        #log div { margin: 5px 0; }
        #button-container { text-align: center; margin-bottom: 20px; }

        /* Styles for the floating number pad */
        #number-pad {
            display: none;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            z-index: 10;
            padding: 5px;
        }

        #number-pad table {
            border-collapse: collapse;
        }

        #number-pad td {
            width: 40px;
            height: 40px;
            text-align: center;
        }

        #number-pad button {
            width: 100%;
            height: 100%;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <h1 style="text-align: center;">Sudoku Journal</h1>

    <div id="button-container">
        <button id="startButton" onclick="startLogging()">Start Logging</button>
        <button id="stopButton" onclick="stopLogging()" style="display: none;">Stop Logging</button>
        <button id="resetButton" onclick="resetGame()" style="display: inline;">Reset</button>
    </div>

    <table>
        <tbody id="sudoku-grid">
            <!-- Rows and cells will be generated here by JavaScript -->
        </tbody>
    </table>

    <div id="log">
        <h2>Move Log:</h2>
        <!-- Logs will appear here -->
    </div>

    <div id="download-container" style="text-align: center; margin-top: 20px;">
        <button id="downloadCSVButton" onclick="downloadCSV()">Download Log (CSV)</button>
        <button id="downloadTXTButton" onclick="downloadTXT()">Download Log (TXT)</button>
        <button id="downloadPDFButton" onclick="downloadPDF()">Download Log (PDF)</button>
    </div>

    <!-- Floating number pad -->
    <div id="number-pad">
        <table>
            <tbody>
                <tr>
                    <td><button onclick="selectNumber(1)">1</button></td>
                    <td><button onclick="selectNumber(2)">2</button></td>
                    <td><button onclick="selectNumber(3)">3</button></td>
                </tr>
                <tr>
                    <td><button onclick="selectNumber(4)">4</button></td>
                    <td><button onclick="selectNumber(5)">5</button></td>
                    <td><button onclick="selectNumber(6)">6</button></td>
                </tr>
                <tr>
                    <td><button onclick="selectNumber(7)">7</button></td>
                    <td><button onclick="selectNumber(8)">8</button></td>
                    <td><button onclick="selectNumber(9)">9</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
    let loggingEnabled = false;
    let startTime = null;
    let totalElapsedTime = 0;
    let logCount = 0;
    let lastInputTime = null;
    let selectedCell = null; // To keep track of which cell was clicked

    function startLogging() {
        if (!loggingEnabled) {
            loggingEnabled = true;
            startTime = new Date().getTime();
            document.getElementById("startButton").style.display = "none";
            document.getElementById("stopButton").style.display = "inline";

            // Disable inputs for pre-filled puzzle numbers
            const inputs = document.querySelectorAll("#sudoku-grid input");
            inputs.forEach(input => {
                if (input.value !== '') {
                    input.setAttribute("readonly", true); // Make pre-filled cells readonly
                    input.style.backgroundColor = "#f0f0f0"; // Optional: Lighten background for clarity
                }
            });

            alert("Logging started! Enter your moves.");
        }
    }

    function stopLogging() {
        if (loggingEnabled) {
            loggingEnabled = false;
            const currentTime = new Date().getTime();
            totalElapsedTime += Math.floor((currentTime - startTime) / 1000);
            document.getElementById("startButton").style.display = "inline";
            document.getElementById("stopButton").style.display = "none";
            alert("Logging stopped!");
            lastInputTime = null;
        }
    }

    function resetGame() {
        const inputs = document.querySelectorAll("#sudoku-grid input");
        inputs.forEach(input => {
            input.value = '';
            input.removeAttribute("readonly"); // Make all cells editable again
            input.style.backgroundColor = ""; // Reset background color
        });
        const logContainer = document.getElementById("log");
        logContainer.innerHTML = '<h2>Move Log:</h2>';
        loggingEnabled = false;
        startTime = null;
        totalElapsedTime = 0;
        logCount = 0;
        lastInputTime = null;
        document.getElementById("startButton").style.display = "inline";
        document.getElementById("stopButton").style.display = "none";
    }

    const grid = document.getElementById("sudoku-grid");
for (let i = 0; i < 9; i++) {
    let row = document.createElement("tr");
    for (let j = 0; j < 9; j++) {
        let cell = document.createElement("td");
        let input = document.createElement("input");
        input.setAttribute("maxlength", "1");

        // Validate input to allow only numbers 1-9
        input.addEventListener("input", function (event) {
            const value = event.target.value;
            if (!/^[1-9]$/.test(value)) {
                event.target.value = ''; // Clear invalid input
            }
            logMove(event); // Call logMove to log the move
        });

        input.addEventListener("click", showNumberPad);
        cell.appendChild(input);
        row.appendChild(cell);
    }
    grid.appendChild(row);
}



    // Show the number pad when a cell is clicked
    function showNumberPad(event) {
        selectedCell = event.target;
        const numberPad = document.getElementById("number-pad");
        numberPad.style.display = "block";
        const rect = selectedCell.getBoundingClientRect();
        numberPad.style.left = `${rect.left}px`;
        numberPad.style.top = `${rect.top + rect.height}px`; // Position below the cell
    }

    // Select a number from the number pad and place it in the selected cell
function selectNumber(number) {
    if (selectedCell && !selectedCell.hasAttribute("readonly")) { // Check if the cell is not readonly
        selectedCell.value = number;
        selectedCell.dispatchEvent(new Event("input")); // Log the move
    }
    hideNumberPad();
}

    // Hide the number pad
    function hideNumberPad() {
        document.getElementById("number-pad").style.display = "none";
    }

    // Close the number pad if the user clicks outside
    document.addEventListener("click", function(event) {
        const numberPad = document.getElementById("number-pad");
        if (!numberPad.contains(event.target) && !selectedCell?.contains(event.target)) {
            hideNumberPad();
        }
    });

    function logMove(event) {
    if (loggingEnabled) {
        let cell = event.target.parentElement;
        let row = cell.parentElement.rowIndex + 1; // Add 1 to make it 1-indexed
        let col = cell.cellIndex + 1; // Column is also 1-indexed
        let value = event.target.value;

        if (value === '') {
            return;
        }

        logCount++;
        const currentTime = new Date().getTime();
        let timeDifference = 0;

        if (lastInputTime !== null) {
            timeDifference = Math.floor((currentTime - lastInputTime) / 1000);
        }

        lastInputTime = currentTime;
        totalElapsedTime += timeDifference;

        // Format the total elapsed time
        const totalHours = Math.floor(totalElapsedTime / 3600);
        const totalMinutes = Math.floor((totalElapsedTime % 3600) / 60);
        const totalSeconds = totalElapsedTime % 60;
        const formattedTotalTime = `${String(totalHours).padStart(2, '0')}:${String(totalMinutes).padStart(2, '0')}:${String(totalSeconds).padStart(2, '0')}`;

        // Format the time since the last move
        const diffHours = Math.floor(timeDifference / 3600);
        const diffMinutes = Math.floor((timeDifference % 3600) / 60);
        const diffSeconds = timeDifference % 60;
        const formattedDiffTime = `${String(diffHours).padStart(2, '0')}:${String(diffMinutes).padStart(2, '0')}:${String(diffSeconds).padStart(2, '0')}`;

        // Get the current timestamp
        const timestamp = new Date().toLocaleTimeString();

        // Create log entry
        const logEntry = document.createElement("div");
        logEntry.textContent = `Move ${logCount}: Cell: (R${row}, C${col}), Value: ${value}, Time since last move: ${formattedDiffTime}, Total Time: ${formattedTotalTime}, Timestamp: ${timestamp}`;
        document.getElementById("log").appendChild(logEntry);
    }
}


    function downloadCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Move,Row,Column,Value,Time since last move,Total Time,Timestamp\n";

    const logEntries = document.querySelectorAll("#log div");
    logEntries.forEach((entry) => {
        const moveMatch = entry.textContent.match(/Move (\d+): Cell: \(R(\d+), C(\d+)\), Value: (\d+), Time since last move: ([\d:]+), Total Time: ([\d:]+), Timestamp: (.+)/);

        if (moveMatch) {
            const [, move, row, col, value, timeSinceLastMove, totalTime, timestamp] = moveMatch;
            const csvRow = `${move},${row},${col},${value},${timeSinceLastMove},${totalTime},${timestamp}\n`;
            csvContent += csvRow;
        }
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "sudoku_log.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


    function downloadTXT() {
        let txtContent = "";
        const logs = document.querySelectorAll("#log div");
        logs.forEach(log => {
            txtContent += log.textContent + "\n";
        });

        const blob = new Blob([txtContent], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "sudoku_log.txt";
        link.click();
    }

    function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4'); // Create a new jsPDF instance in portrait orientation

    doc.setFontSize(10); // Set a smaller font size (adjust as needed)

    // Add column titles
    doc.text("Move,Coordinates,Value,Time since last move,Total Time,Timestamp", 20, 30);
    
    let yPosition = 50; // Starting vertical position for log entries

    const logs = document.querySelectorAll("#log div");
    logs.forEach((log, index) => {
        const logText = log.textContent;

        // Split logText into an array of lines to manage line breaks
        const lines = doc.splitTextToSize(logText, 550); // Adjust width for text fitting

        lines.forEach((line) => {
            if (yPosition > 750) { // If yPosition exceeds 750 (adjust based on your margins)
                doc.addPage(); // Add a new page
                yPosition = 30; // Reset yPosition for new page
                doc.text("Move,Coordinates,Value,Time since last move,Total Time,Timestamp", 20, 30); // Re-add column titles
                yPosition += 20; // Leave space after titles
                doc.setFontSize(10); // Reset font size on new page
            }
            doc.text(line, 20, yPosition); // Position the text with some margin
            yPosition += 20; // Increase yPosition for next log entry
        });
    });

    doc.save("sudoku_log.pdf");
}


</script>

</body>
</html>
